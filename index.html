<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Note2Brain App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button {
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
        }
        .nav-link {
            transition: all 0.2s;
        }
        .nav-link.active {
            background-color: #4f46e5;
            color: white;
        }
        .quiz-option.selected {
            background-color: #e0e7ff; /* indigo-100 */
            border-color: #4f46e5; /* indigo-600 */
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, serverTimestamp, setDoc, getDocs, writeBatch, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global State Variables ---
        let db;
        let auth;
        let userId;
        let userDisplayName;
        let appId = 'note2brain-app'; // Manually set for deployment
        
        // Feature States
        let currentQuizData = [];
        let currentQuizIndex = 0;
        let examQuestions = [];
        let currentExamIndex = 0;
        let examAnswers = {};
        let userPerformance = { correct: 0, incorrect: 0, topicIssues: {} };
        let performanceChartInstance = null;
        let topicChartInstance = null;

        // --- UI Helper Functions ---
        const showMessage = (message, type = 'info') => {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = 'fixed top-4 right-4 z-50 p-3 rounded-lg shadow-lg text-sm text-white ' + (type === 'error' ? 'bg-red-500' : 'bg-blue-500');
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        };

        const setLoading = (isLoading, message = 'Processing...') => {
            const loadingOverlay = document.getElementById('loading-overlay');
            document.getElementById('loading-message').textContent = message;
            loadingOverlay.classList.toggle('hidden', !isLoading);
        };

        const setLoggedInState = (isLoggedIn) => {
            document.getElementById('login-page').classList.toggle('hidden', isLoggedIn);
            document.getElementById('dashboard-page').classList.toggle('hidden', !isLoggedIn);
        };
        
        // --- Gemini API Functions ---
        const fetchTextFromVision = async (base64ImageData) => {
            setLoading(true, 'Extracting text from image...');
            const prompt = "Extract all text from the image, focusing on key concepts and important facts. Preserve the original language and formatting as much as possible.";
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64ImageData } }] }] };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            for (let retries = 0; retries < 5; retries++) {
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        setLoading(false);
                        return result.candidates[0].content.parts[0].text;
                    }
                } catch (e) {
                    if (retries === 4) {
                        setLoading(false);
                        throw new Error(`Failed to get response after multiple retries: ${e.message}`);
                    }
                    await new Promise(res => setTimeout(res, 1000 * Math.pow(2, retries)));
                }
            }
        };
        
        const fetchStructuredChatResponse = async (prompt, responseSchema) => {
            setLoading(true, 'Generating study materials...');
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema } };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            for (let retries = 0; retries < 5; retries++) {
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const result = await response.json();
                    setLoading(false);
                    return JSON.parse(result.candidates[0].content.parts[0].text);
                } catch (e) {
                     if (retries === 4) {
                        setLoading(false);
                        throw new Error(`Failed to get structured response after multiple retries: ${e.message}`);
                    }
                    await new Promise(res => setTimeout(res, 1000 * Math.pow(2, retries)));
                }
            }
        };
        
        // --- Core Application Logic ---
        const generateFlashcardsAndMCQs = async (notesText) => {
            try {
                const schema = { type: "OBJECT", properties: { flashcards: { type: "ARRAY", items: { type: "OBJECT", properties: { q: { "type": "STRING" }, a: { "type": "STRING" } } } }, mcqs: { type: "ARRAY", items: { type: "OBJECT", properties: { question: { "type": "STRING" }, options: { "type": "ARRAY", "items": { "type": "STRING" } }, correct: { "type": "STRING" } } } }, pyqs: { type: "ARRAY", items: { type: "OBJECT", properties: { question: { "type": "STRING" }, options: { "type": "ARRAY", "items": { "type": "STRING" } }, correct: { "type": "STRING" } } } } } };
                const prompt = `From the following text, extract all key concepts, definitions, and important facts. Infer the subject and academic level. Generate a comprehensive set of flashcards (Q&A) and multiple-choice questions (with one correct answer and three distractors). Additionally, act as an expert tutor and find or create a few relevant previous year questions (PYQs). Return all content in the specified JSON format. Text: ${notesText}`;
                const response = await fetchStructuredChatResponse(prompt, schema);
                if (!response?.flashcards || !response?.mcqs || !response?.pyqs) throw new Error('AI response was malformed.');
                return response;
            } catch (e) {
                showMessage(`AI processing failed: ${e.message}`, 'error');
                return null;
            }
        };
        
        const processFile = async (file) => {
            if (file.type === 'application/pdf') {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async () => {
                        try {
                            setLoading(true, 'Reading PDF file...');
                            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js`;
                            const pdf = await pdfjsLib.getDocument({ data: reader.result }).promise;
                            let text = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const content = await page.getTextContent();
                                text += content.items.map(item => item.str).join(' ') + ' ';
                            }
                            setLoading(false);
                            resolve(text);
                        } catch (e) { setLoading(false); reject(new Error('Failed to read PDF.')); }
                    };
                    reader.onerror = () => reject(new Error('File reader error.'));
                    reader.readAsArrayBuffer(file);
                });
            } else if (file.type.startsWith('image/')) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async () => {
                        try { resolve(await fetchTextFromVision(reader.result.split(',')[1])); } 
                        catch (e) { reject(new Error(`Image processing failed: ${e.message}`)); }
                    };
                    reader.onerror = () => reject(new Error('File reader error.'));
                    reader.readAsDataURL(file);
                });
            } else {
                throw new Error('Unsupported file type.');
            }
        };

        const handleSubmitNotes = async () => {
            const textTab = document.getElementById('text-input-tab');
            let notesText = '';

            if (!textTab.classList.contains('hidden')) {
                notesText = document.getElementById('notes-text').value;
            } else {
                const file = document.getElementById('file-input').files[0];
                if (!file) {
                    showMessage('Please select a file to upload.', 'error');
                    return;
                }
                try {
                    notesText = await processFile(file);
                } catch (e) {
                    showMessage(e.message, 'error');
                    return;
                }
            }

            if (!notesText?.trim()) {
                showMessage('Notes text is empty. Please paste text or upload a file.', 'error');
                return;
            }

            const results = await generateFlashcardsAndMCQs(notesText);
            if (results) {
                const noteDoc = { notes: notesText.substring(0, 200) + '...', ...results, createdAt: serverTimestamp() };
                try {
                    setLoading(true, 'Saving to database...');
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/notes`), noteDoc);
                    showMessage('Notes processed and saved!', 'info');
                    document.getElementById('notes-text').value = '';
                    document.getElementById('file-input').value = '';
                } catch (e) {
                    showMessage(`Error saving data: ${e.message}`, 'error');
                } finally {
                    setLoading(false);
                }
            }
        };
        
        // --- Rendering Functions ---
        const renderFlashcards = (flashcards) => {
            const container = document.getElementById('flashcard-container');
            container.innerHTML = (!flashcards || flashcards.length === 0) ? 
                '<div class="col-span-full bg-white p-4 rounded-xl shadow-sm border"><h4 class="font-semibold">No flashcards found. Upload notes to get started.</h4></div>' :
                flashcards.map(card => `<div class="bg-white p-4 rounded-xl shadow-sm border cursor-pointer hover:shadow-md transition-shadow"><h4 class="font-semibold">Q: ${card.q}</h4><p class="hidden mt-2 text-slate-600">A: ${card.a}</p></div>`).join('');
            container.querySelectorAll('.bg-white').forEach(cardDiv => cardDiv.addEventListener('click', () => cardDiv.querySelector('p').classList.toggle('hidden')));
        };
        
        const renderPyqs = (pyqs) => {
            const container = document.getElementById('pyq-container');
            container.innerHTML = (!pyqs || pyqs.length === 0) ? 
                '<div class="bg-white p-4 rounded-xl shadow-sm border"><h4 class="font-semibold">No PYQs found.</h4></div>' :
                pyqs.map(pyq => `<div class="bg-white p-4 rounded-xl shadow-sm border"><h4 class="font-semibold">Q: ${pyq.question}</h4><div class="mt-2 text-slate-600">${pyq.options.map(o => `<span class="inline-block bg-slate-100 px-3 py-1 rounded-full text-sm font-medium mr-2 mb-2">${o}</span>`).join('')}</div><p class="mt-2 text-green-600 font-bold">Correct: ${pyq.correct}</p></div>`).join('');
        };

        // --- Community / Friends Logic ---
        const copyUserId = () => {
            const tempInput = document.createElement('textarea');
            tempInput.value = userId;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showMessage('Your User ID has been copied to the clipboard!', 'info');
        };

        const handleSendFriendRequest = async () => {
            const friendIdInput = document.getElementById('friend-id-input');
            const friendId = friendIdInput.value.trim();

            if (!friendId) { showMessage('Please enter a User ID.', 'error'); return; }
            if (friendId === userId) { showMessage("You can't add yourself as a friend.", 'error'); return; }

            setLoading(true, 'Sending request...');
            try {
                const requestRef = doc(db, `artifacts/${appId}/users/${friendId}/friendRequests/${userId}`);
                await setDoc(requestRef, {
                    senderName: userDisplayName,
                    status: 'pending',
                    sentAt: serverTimestamp()
                });
                showMessage('Friend request sent!', 'info');
                friendIdInput.value = '';
            } catch (e) {
                showMessage('Failed to send request. Check the User ID and try again.', 'error');
            } finally {
                setLoading(false);
            }
        };

        const handleAcceptFriendRequest = async (senderId, senderName) => {
            const batch = writeBatch(db);
            const currentUserFriendRef = doc(db, `artifacts/${appId}/users/${userId}/friends/${senderId}`);
            batch.set(currentUserFriendRef, { friendName: senderName, addedAt: serverTimestamp() });
            const senderFriendRef = doc(db, `artifacts/${appId}/users/${senderId}/friends/${userId}`);
            batch.set(senderFriendRef, { friendName: userDisplayName, addedAt: serverTimestamp() });
            const requestRef = doc(db, `artifacts/${appId}/users/${userId}/friendRequests/${senderId}`);
            batch.delete(requestRef);
            
            await batch.commit();
            showMessage('Friend added!', 'info');
        };

        const handleDeclineFriendRequest = async (senderId) => {
            const requestRef = doc(db, `artifacts/${appId}/users/${userId}/friendRequests/${senderId}`);
            await deleteDoc(requestRef);
            showMessage('Request declined.', 'info');
        };

        const renderFriendRequests = (requests) => {
            const container = document.getElementById('friend-requests-container');
            container.innerHTML = requests.length === 0 ? '<p class="text-slate-500">No new friend requests.</p>' :
                requests.map(req => `
                    <div class="flex items-center justify-between p-3 bg-slate-100 rounded-lg">
                        <p class="text-sm font-medium">${req.senderName || 'A User'}</p>
                        <div>
                            <button class="accept-request-btn text-xs bg-green-500 text-white py-1 px-2 rounded-md hover:bg-green-600" data-id="${req.id}" data-name="${req.senderName}">Accept</button>
                            <button class="decline-request-btn text-xs bg-red-500 text-white py-1 px-2 rounded-md hover:bg-red-600 ml-2" data-id="${req.id}">Decline</button>
                        </div>
                    </div>
                `).join('');
            
            container.querySelectorAll('.accept-request-btn').forEach(btn => btn.addEventListener('click', (e) => handleAcceptFriendRequest(e.target.dataset.id, e.target.dataset.name)));
            container.querySelectorAll('.decline-request-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeclineFriendRequest(e.target.dataset.id)));
        };

        const renderFriendsList = (friends) => {
            const container = document.getElementById('friends-list-container');
            container.innerHTML = friends.length === 0 ? '<p class="text-slate-500">You haven\'t added any friends yet.</p>' :
                friends.map(friend => `<div class="p-3 bg-slate-100 rounded-lg text-sm font-medium">${friend.friendName}</div>`).join('');
        };

        // --- Quiz & Exam Logic ---
        const getAllQuestions = async () => {
            if (!userId) return [];
            const notesCollectionPath = `artifacts/${appId}/users/${userId}/notes`;
            const notesSnapshot = await getDocs(collection(db, notesCollectionPath));
            if (notesSnapshot.empty) return [];
            
            const allQuestions = [];
            notesSnapshot.docs.forEach(doc => {
                const data = doc.data();
                if (data.mcqs && Array.isArray(data.mcqs)) allQuestions.push(...data.mcqs);
                if (data.pyqs && Array.isArray(data.pyqs)) allQuestions.push(...data.pyqs);
            });
            return allQuestions;
        };

        const startQuiz = async () => {
            setLoading(true, 'Preparing quiz...');
            const allQuestions = await getAllQuestions();
            if (allQuestions.length < 1) {
                showMessage('Not enough questions to start a quiz. Please upload more notes.', 'error');
                setLoading(false);
                return;
            }
            
            currentQuizData = allQuestions.sort(() => 0.5 - Math.random()).slice(0, 5);
            currentQuizIndex = 0;
            document.getElementById('start-quiz-btn').classList.add('hidden');
            renderQuizQuestion(currentQuizData[currentQuizIndex]);
            setLoading(false);
        };

        const renderQuizQuestion = (questionData) => {
            const quizContainer = document.getElementById('quiz-question-container');
            if (!questionData) {
                quizContainer.innerHTML = '<p class="text-lg text-slate-600">Quiz finished! Check your analytics for results.</p>';
                document.getElementById('next-question-btn').classList.add('hidden');
                document.getElementById('start-quiz-btn').classList.remove('hidden');
                return;
            }
            quizContainer.innerHTML = `<h4 class="font-semibold text-xl mb-4">${questionData.question}</h4><div id="quiz-options" class="space-y-2">${questionData.options.map(option => `<button class="quiz-option w-full text-left p-3 rounded-lg shadow-sm border border-slate-200 hover:bg-slate-100 transition" data-option="${option}">${option}</button>`).join('')}</div><div id="quiz-feedback" class="mt-4 hidden"></div>`;
            document.getElementById('next-question-btn').classList.add('hidden');
            document.querySelectorAll('.quiz-option').forEach(button => button.addEventListener('click', handleQuizAnswer));
        };

        const handleQuizAnswer = (event) => {
            const selectedButton = event.target.closest('.quiz-option');
            const selectedOption = selectedButton.dataset.option;
            const correctOption = currentQuizData[currentQuizIndex].correct;
            const feedbackDiv = document.getElementById('quiz-feedback');
            
            document.querySelectorAll('.quiz-option').forEach(button => {
                button.disabled = true;
                if(button.dataset.option === correctOption) button.classList.add('bg-green-200');
                if(button.dataset.option === selectedOption && selectedOption !== correctOption) button.classList.add('bg-red-200');
            });
            
            if (selectedOption === correctOption) {
                feedbackDiv.innerHTML = '<p class="text-green-600 font-bold">Correct!</p>';
                updatePerformance(true, currentQuizData[currentQuizIndex].question);
            } else {
                feedbackDiv.innerHTML = `<p class="text-red-600 font-bold">Incorrect. The correct answer was: ${correctOption}</p>`;
                updatePerformance(false, currentQuizData[currentQuizIndex].question);
            }
            feedbackDiv.classList.remove('hidden');
            document.getElementById('next-question-btn').classList.remove('hidden');
        };

        const nextQuestion = () => {
            currentQuizIndex++;
            if (currentQuizIndex < currentQuizData.length) {
                renderQuizQuestion(currentQuizData[currentQuizIndex]);
            } else {
                renderQuizQuestion(null);
            }
        };

        const startExam = async () => {
            setLoading(true, 'Preparing your exam...');
            const allQuestions = await getAllQuestions();
            const EXAM_LENGTH = 10;

            if (allQuestions.length < EXAM_LENGTH) {
                showMessage(`You need at least ${EXAM_LENGTH} questions to start an exam.`, 'error');
                setLoading(false);
                return;
            }

            examQuestions = allQuestions.sort(() => 0.5 - Math.random()).slice(0, EXAM_LENGTH);
            currentExamIndex = 0;
            examAnswers = {};

            document.getElementById('exam-intro-container').classList.add('hidden');
            document.getElementById('exam-container').classList.remove('hidden');
            document.getElementById('exam-results-container').classList.add('hidden');
            document.getElementById('exam-next-btn').classList.remove('hidden');
            document.getElementById('exam-submit-btn').classList.add('hidden');

            renderExamQuestion(currentExamIndex);
            setLoading(false);
        };

        const renderExamQuestion = (index) => {
            const questionData = examQuestions[index];
            const container = document.getElementById('exam-question-container');
            container.innerHTML = `<h3 class="text-lg font-semibold mb-2">Question ${index + 1} of ${examQuestions.length}</h3><p class="text-xl mb-4">${questionData.question}</p><div class="space-y-3">${questionData.options.map((option, i) => `<div><input type="radio" name="exam-option" id="option${i}" value="${option}" class="mr-2"><label for="option${i}">${option}</label></div>`).join('')}</div>`;
        };

        const handleExamNext = () => {
            const selectedOption = document.querySelector('input[name="exam-option"]:checked');
            examAnswers[currentExamIndex] = selectedOption ? selectedOption.value : null;
            currentExamIndex++;
            renderExamQuestion(currentExamIndex);

            if (currentExamIndex === examQuestions.length - 1) {
                document.getElementById('exam-next-btn').classList.add('hidden');
                document.getElementById('exam-submit-btn').classList.remove('hidden');
            }
        };

        const submitExam = async () => {
            const selectedOption = document.querySelector('input[name="exam-option"]:checked');
            examAnswers[currentExamIndex] = selectedOption ? selectedOption.value : null;
            setLoading(true, 'Submitting exam...');
            let score = 0;
            let tempPerformance = { ...userPerformance };

            for (let i = 0; i < examQuestions.length; i++) {
                const question = examQuestions[i];
                const isCorrect = examAnswers[i] === question.correct;
                if (isCorrect) {
                    score++;
                    tempPerformance.correct = (tempPerformance.correct || 0) + 1;
                } else {
                    tempPerformance.incorrect = (tempPerformance.incorrect || 0) + 1;
                    const topic = question.question.split(' ').slice(0, 3).join(' ');
                    tempPerformance.topicIssues[topic] = (tempPerformance.topicIssues[topic] || 0) + 1;
                }
            }
            const statsRef = doc(db, `artifacts/${appId}/users/${userId}/stats/performance`);
            await setDoc(statsRef, tempPerformance);
            renderExamResults(score);
            setLoading(false);
        };

        const renderExamResults = (score) => {
            document.getElementById('exam-question-container').innerHTML = '';
            document.getElementById('exam-next-btn').classList.add('hidden');
            document.getElementById('exam-submit-btn').classList.add('hidden');
            
            const resultsContainer = document.getElementById('exam-results-container');
            resultsContainer.classList.remove('hidden');
            resultsContainer.innerHTML = `<h2 class="text-2xl font-bold mb-4">Exam Complete!</h2><p class="text-xl mb-2">Your score: <span class="font-bold text-indigo-600">${score} / ${examQuestions.length}</span></p><p class="text-lg mb-6">That's <span class="font-bold">${((score / examQuestions.length) * 100).toFixed(1)}%</span>!</p><button id="retake-exam-btn" class="w-full py-3 mt-6 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition">Take Another Exam</button>`;
            document.getElementById('retake-exam-btn').addEventListener('click', () => {
                 document.getElementById('exam-results-container').classList.add('hidden');
                 document.getElementById('exam-intro-container').classList.remove('hidden');
            });
        };

        // --- Analytics & Data ---
        const updatePerformance = async (isCorrect, questionText) => {
            if (!userId) return;
            const topic = questionText.split(' ').slice(0, 3).join(' ');
            const statsRef = doc(db, `artifacts/${appId}/users/${userId}/stats/performance`);
            let newStats = { ...userPerformance };
            newStats.correct = (newStats.correct || 0) + (isCorrect ? 1 : 0);
            newStats.incorrect = (newStats.incorrect || 0) + (isCorrect ? 0 : 1);
            if (!isCorrect) {
                newStats.topicIssues[topic] = (newStats.topicIssues[topic] || 0) + 1;
            }
            try { await setDoc(statsRef, newStats); } catch (e) { console.error('Error updating performance stats:', e); }
        };

        const renderAnalytics = () => {
            if (!userId) return;
            let statsRef = doc(db, `artifacts/${appId}/users/${userId}/stats/performance`);
            onSnapshot(statsRef, (doc) => {
                userPerformance = doc.exists() ? doc.data() : { correct: 0, incorrect: 0, topicIssues: {} };
                renderAnalyticsCharts();
            });
        };

        const renderAnalyticsCharts = () => {
            const performanceCtx = document.getElementById('performanceChart')?.getContext('2d');
            if (performanceCtx) {
                if (performanceChartInstance) performanceChartInstance.destroy();
                performanceChartInstance = new Chart(performanceCtx, { type: 'doughnut', data: { labels: ['Correct', 'Incorrect'], datasets: [{ data: [userPerformance.correct || 0, userPerformance.incorrect || 0], backgroundColor: ['#4ade80', '#f87171'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Overall Performance' } } } });
            }
            const topicCtx = document.getElementById('topicChart')?.getContext('2d');
            const topicIssues = userPerformance.topicIssues || {};
            if (topicCtx) {
                if (topicChartInstance) topicChartInstance.destroy();
                topicChartInstance = new Chart(topicCtx, { type: 'bar', data: { labels: Object.keys(topicIssues), datasets: [{ label: 'Questions Answered Incorrectly', data: Object.values(topicIssues), backgroundColor: '#f87171' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Topics Needing Review' } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
            }
        };

        // --- Navigation & UI Setup ---
        const navigateTo = (sectionId) => {
            document.querySelectorAll('.content-section').forEach(section => section.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`.nav-link[data-section="${sectionId}"]`).classList.add('active');
        };
        const updateInputTab = (tabName) => {
            document.querySelectorAll('#upload-section .tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabName).classList.remove('hidden');
            document.querySelectorAll('.input-tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.input-tab-button[data-tab="${tabName}"]`).classList.add('active');
        };
        
        // --- Authentication Handlers ---
        const handleGoogleSignIn = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (e) { showMessage(`Google Sign-In failed: ${e.message}`, 'error'); } };
        const handleAnonymousSignIn = async () => { try { await signInAnonymously(auth); } catch (e) { showMessage(`Anonymous Sign-In failed: ${e.message}`, 'error'); } };
        const handleLogout = async () => { try { await signOut(auth); } catch (e) { showMessage(`Logout failed: ${e.message}`, 'error'); } };

        // --- Window Onload / App Initialization ---
        window.onload = async () => {
            // Your web app's Firebase configuration
            const firebaseConfig = {
              apiKey: "AIzaSyCJB_kTc6HNXGc4grLK4KgfrRTyz6xUnGQ",
              authDomain: "study2note.firebaseapp.com",
              projectId: "study2note",
              storageBucket: "study2note.firebasestorage.app",
              messagingSenderId: "559480454889",
              appId: "1:559480454889:web:09f40a0b5ca5d49505fa78",
              measurementId: "G-KC0WEYSS17"
            };

            if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") { 
                showMessage('Firebase config missing. Please add your Firebase project keys to index.html', 'error'); 
                return; 
            }
            
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userDisplayName = user.isAnonymous ? 'Anonymous User' : user.displayName || user.email || `User_${user.uid.substring(0, 6)}`;
                    document.getElementById('user-id-display').textContent = `ID: ${userId}`;
                    document.getElementById('shareable-user-id').textContent = userId;
                    setLoggedInState(true);
                    navigateTo('home-section');
                    
                    onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/notes`), (snapshot) => {
                        const allContent = { flashcards: [], mcqs: [], pyqs: [] };
                        snapshot.docs.forEach(doc => { const data = doc.data(); if(data.flashcards) allContent.flashcards.push(...data.flashcards); if(data.mcqs) allContent.mcqs.push(...data.mcqs); if(data.pyqs) allContent.pyqs.push(...data.pyqs); });
                        renderFlashcards(allContent.flashcards);
                        renderPyqs(allContent.pyqs);
                    });
                    onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/friendRequests`), (snapshot) => renderFriendRequests(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                    onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/friends`), (snapshot) => renderFriendsList(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                    renderAnalytics();
                } else {
                    setLoggedInState(false);
                    userId = null;
                }
            });
            
            // --- Event Listeners ---
            document.getElementById('google-signin-btn').addEventListener('click', handleGoogleSignIn);
            document.getElementById('anon-signin-btn').addEventListener('click', handleAnonymousSignIn);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('submit-notes-btn').addEventListener('click', handleSubmitNotes);
            document.getElementById('start-quiz-btn').addEventListener('click', startQuiz);
            document.getElementById('next-question-btn').addEventListener('click', nextQuestion);
            document.getElementById('start-exam-btn').addEventListener('click', startExam);
            document.getElementById('exam-next-btn').addEventListener('click', handleExamNext);
            document.getElementById('exam-submit-btn').addEventListener('click', submitExam);
            document.getElementById('copy-id-btn').addEventListener('click', copyUserId);
            document.getElementById('send-request-btn').addEventListener('click', handleSendFriendRequest);
            document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', () => navigateTo(link.dataset.section)));
            document.querySelectorAll('.input-tab-button').forEach(button => button.addEventListener('click', () => updateInputTab(button.dataset.tab)));
            updateInputTab('text-input-tab');
        };
    </script>
</head>
<body class="bg-slate-50 text-slate-800 antialiased">
    <div id="message-box" class="fixed top-4 right-4 z-50 p-3 rounded-lg shadow-lg hidden"></div>
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-70 flex items-center justify-center z-40 hidden">
        <div class="flex flex-col items-center"><svg class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p id="loading-message" class="mt-4 text-indigo-600 font-medium">Processing...</p></div>
    </div>
    
    <!-- Login Page -->
    <div id="login-page" class="flex flex-col items-center justify-center min-h-screen text-center p-4">
        <h1 class="text-4xl md:text-5xl font-bold text-slate-900 mb-2">Note2Brain</h1>
        <p class="text-lg md:text-xl text-indigo-600 font-semibold mb-8">Your AI-powered study partner for JEE & NEET.</p>
        <div class="space-y-4 max-w-sm w-full mx-auto p-8 bg-white rounded-xl shadow-lg border border-slate-200">
            <button id="google-signin-btn" class="w-full py-3 bg-white text-slate-700 font-semibold rounded-lg shadow-sm border border-slate-300 hover:bg-slate-100 transition flex items-center justify-center"><svg class="w-5 h-5 mr-3" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 35.245 44 30.028 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>Sign in with Google</button>
            <button id="anon-signin-btn" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition">Continue Anonymously</button>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard-page" class="flex flex-col md:flex-row min-h-screen hidden">
        <!-- Sidebar Navigation -->
        <nav class="md:w-64 w-full bg-slate-800 text-white p-6 flex flex-col items-center md:items-start md:h-screen md:sticky top-0 shadow-lg">
            <h2 class="text-2xl font-bold text-white mb-6 w-full text-center md:text-left">Note2Brain</h2>
            <div class="w-full space-y-2">
                <button class="nav-link w-full py-2 px-4 rounded-lg text-left hover:bg-slate-700 transition active" data-section="home-section">Home</button>
                <button class="nav-link w-full py-2 px-4 rounded-lg text-left hover:bg-slate-700 transition" data-section="community-section">Community</button>
                <button class="nav-link w-full py-2 px-4 rounded-lg text-left hover:bg-slate-700 transition" data-section="flashcard-section">Flashcards</button>
                <button class="nav-link w-full py-2 px-4 rounded-lg text-left hover:bg-slate-700 transition" data-section="pyq-section">PYQs</button>
                <button class="nav-link w-full py-2 px-4 rounded-lg text-left hover:bg-slate-700 transition" data-section="quiz-section">Quiz</button>
                <button class="nav-link w-full py-2 px-4 rounded-lg text-left hover:bg-slate-700 transition" data-section="exam-mode-section">Exam Mode</button>
                <button class="nav-link w-full py-2 px-4 rounded-lg text-left hover:bg-slate-700 transition" data-section="analytics-section">Analytics</button>
            </div>
            <div class="mt-auto w-full pt-4">
                 <p id="user-id-display" class="text-xs text-slate-400 break-all mb-4"></p>
                 <button id="logout-btn" class="w-full py-2 px-4 rounded-lg text-left hover:bg-red-600 transition bg-red-500">Logout</button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow p-6 md:p-10">
            <div id="home-section" class="content-section">
                <header class="text-center mb-8"><h1 class="text-4xl font-bold text-slate-900">Dashboard</h1><p class="text-lg text-slate-600 mt-2">Upload your notes to generate powerful study materials.</p></header>
                <section id="upload-section" class="mb-10 p-6 bg-white rounded-xl shadow-sm border border-slate-200 max-w-3xl mx-auto"><h2 class="text-2xl font-bold text-slate-900 mb-4">Upload Your Notes</h2><div class="flex justify-center mb-4 border-b border-slate-200"><button data-tab="text-input-tab" class="input-tab-button px-4 py-2 text-sm font-medium text-slate-600 hover:text-indigo-600 active">Paste Text</button><button data-tab="file-upload-tab" class="input-tab-button px-4 py-2 text-sm font-medium text-slate-600 hover:text-indigo-600">Upload File</button></div><div id="text-input-tab" class="tab-content space-y-4"><textarea id="notes-text" class="w-full h-40 p-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Paste your notes here..."></textarea></div><div id="file-upload-tab" class="tab-content space-y-4 hidden"><input type="file" id="file-input" accept=".pdf,image/jpeg,image/png" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"></div><button id="submit-notes-btn" class="w-full py-3 mt-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition">Process Notes</button></section>
            </div>

            <div id="community-section" class="content-section hidden">
                <h2 class="text-3xl font-bold text-slate-900 mb-6">Community</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="space-y-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="text-xl font-bold text-slate-800 mb-3">Your Unique ID</h3>
                            <p class="text-slate-600 mb-4">Share this ID with your friends so they can add you.</p>
                            <div class="flex items-center p-3 bg-slate-100 rounded-lg">
                                <span id="shareable-user-id" class="text-sm font-mono text-slate-700 flex-grow break-all"></span>
                                <button id="copy-id-btn" class="ml-4 py-2 px-3 bg-indigo-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition">Copy</button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                             <h3 class="text-xl font-bold text-slate-800 mb-3">Add a Friend</h3>
                             <p class="text-slate-600 mb-4">Enter your friend's User ID to send a request.</p>
                             <div class="flex items-center space-x-2">
                                 <input type="text" id="friend-id-input" placeholder="Paste User ID here" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                 <button id="send-request-btn" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition">Send</button>
                             </div>
                        </div>
                    </div>
                    <div class="space-y-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                             <h3 class="text-xl font-bold text-slate-800 mb-4">Friend Requests</h3>
                             <div id="friend-requests-container" class="space-y-3"><p class="text-slate-500">No new friend requests.</p></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                             <h3 class="text-xl font-bold text-slate-800 mb-4">Your Friends</h3>
                             <div id="friends-list-container" class="space-y-3"><p class="text-slate-500">You haven't added any friends yet.</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="flashcard-section" class="content-section hidden"><h2 class="text-3xl font-bold text-slate-900 mb-6">Your Flashcards</h2><div id="flashcard-container" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
            <div id="pyq-section" class="content-section hidden"><h2 class="text-3xl font-bold text-slate-900 mb-6">Previous Year Questions (PYQs)</h2><div id="pyq-container" class="space-y-4"></div></div>
            <div id="quiz-section" class="content-section hidden"><h2 class="text-3xl font-bold text-slate-900 mb-6">Quiz Yourself</h2><div class="bg-white p-6 rounded-xl shadow-sm border max-w-3xl mx-auto"><div id="quiz-question-container"><p class="text-lg text-slate-600">Start a quiz to practice.</p></div><div class="mt-6 flex justify-center"><button id="start-quiz-btn" class="py-2 px-6 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition">Start Quiz</button><button id="next-question-btn" class="py-2 px-6 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition hidden">Next Question</button></div></div></div>
            <div id="exam-mode-section" class="content-section hidden"><h2 class="text-3xl font-bold text-slate-900 mb-6">Exam Mode</h2><div id="exam-intro-container" class="bg-white p-6 rounded-xl shadow-sm border max-w-3xl mx-auto text-center"><p class="text-lg text-slate-600">Take a 10-question exam generated from your notes.</p><button id="start-exam-btn" class="w-full py-3 mt-6 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition">Start Exam</button></div><div id="exam-container" class="bg-white p-6 rounded-xl shadow-sm border max-w-3xl mx-auto hidden"><div id="exam-question-container"></div><div id="exam-results-container" class="hidden text-center"></div><div class="mt-6 flex justify-end"><button id="exam-next-btn" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition hidden">Next</button><button id="exam-submit-btn" class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition hidden">Submit Exam</button></div></div></div>
            <div id="analytics-section" class="content-section hidden"><h2 class="text-3xl font-bold text-slate-900 mb-6">Your Performance</h2><div class="grid md:grid-cols-2 gap-8"><div class="bg-white p-6 rounded-xl shadow-sm border"><div class="h-80"><canvas id="performanceChart"></canvas></div><p class="mt-4 text-center text-slate-600">Overall performance from all quizzes.</p></div><div class="bg-white p-6 rounded-xl shadow-sm border"><div class="h-80"><canvas id="topicChart"></canvas></div><p class="mt-4 text-center text-slate-600">Topics needing more practice.</p></div></div></div>
        </main>
    </div>
    <footer class="text-center py-8 border-t border-slate-200 mt-10"><p class="text-slate-500 text-sm">Powered by Gemini AI and Firebase Firestore.</p></footer>
</body>
</html>
